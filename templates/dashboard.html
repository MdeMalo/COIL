<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <style>
        body { font-family: Arial; padding: 20px; background:#f7f7f7 }
        .card { background:white; padding:15px; border-radius:6px; margin-bottom:12px }
        .btn { display:inline-block; padding:8px 12px; background:#007bff; color:white; text-decoration:none; border-radius:4px }
    </style>
</head>
<body>
    <a class="btn" href="/">← Volver</a>
    <h1>Dashboard</h1>

    <style>
        /* Limitar alturas de las gráficas para evitar páginas muy largas */
        .chart-container { width: 100%; max-width: 900px; height: 340px; margin: 0 auto; }
        @media (max-width: 768px) { .chart-container { height: 260px; } }
        canvas { width: 100% !important; height: 100% !important; }
    </style>

    <div class="card">
        <h3>Conteo por tipo</h3>
        <div class="chart-container">
            <canvas id="chartConteos"></canvas>
        </div>
    </div>

    <div class="card">
        <h3>Historial temporal</h3>
        <div class="chart-container">
            <canvas id="chartSerie"></canvas>
        </div>
    </div>

    <div class="card">
        <h3>Promedios de parámetros</h3>
        <table id="tablaPromedios">
            <tr><th>Profundidad (mm)</th><td id="p_profundidad">-</td></tr>
            <tr><th>Longitud (cm)</th><td id="p_longitud">-</td></tr>
            <tr><th>Temp ambiente (°C)</th><td id="p_temp">-</td></tr>
            <tr><th>Humedad relativa (%)</th><td id="p_humedad">-</td></tr>
            <tr><th>Edad concreto (hrs)</th><td id="p_edad">-</td></tr>
            <tr><th>Exposición viento (km/h)</th><td id="p_viento">-</td></tr>
        </table>
    </div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        async function fetchData() {
            const resp = await fetch('/api/dashboard_data');
            if (!resp.ok) {
                console.error('Error fetching dashboard data', resp.statusText);
                return null;
            }
            return await resp.json();
        }

        function renderConteos(conteos) {
            const labels = conteos.map(c => c.resultado);
            const data = conteos.map(c => c.cnt);
            const ctx = document.getElementById('chartConteos').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cantidad',
                        data: data,
                        backgroundColor: '#4A90E2'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderSerie(serie) {
            const labels = serie.map(s => s.fecha);
            const data = serie.map(s => s.cnt);
            const ctx = document.getElementById('chartSerie').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Registros por fecha',
                        data: data,
                        borderColor: '#d9534f',
                        tension: 0.2,
                        fill: false
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderPromedios(promedios) {
            document.getElementById('p_profundidad').textContent = promedios.profundidad_mm ?? '-';
            document.getElementById('p_longitud').textContent = promedios.longitud_cm ?? '-';
            document.getElementById('p_temp').textContent = promedios.temp_ambiente_C ?? '-';
            document.getElementById('p_humedad').textContent = promedios.humedad_relativa ?? '-';
            document.getElementById('p_edad').textContent = promedios.edad_concreto_horas ?? '-';
            document.getElementById('p_viento').textContent = promedios.exposicion_viento_kmh ?? '-';
        }

        (async () => {
            const data = await fetchData();
            if (!data) return;
            if (data.conteos) renderConteos(data.conteos);
            if (data.serie) renderSerie(data.serie);
            if (data.promedios) renderPromedios(data.promedios);
        })();
    </script>

</body>
</html>