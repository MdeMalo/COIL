<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Historial de Reportes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <style>
        body { background: #f7f7f7; }
        .page-header { margin: 18px 0; }
        .filters .form-control, .filters .form-select { min-width: 140px; }
        .table-wrap { background: #fff; padding: 12px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
        .small-muted { font-size: 0.9rem; color: #666; }
        .action-btn { margin-right:6px; }
    </style>
</head>
<body>
<div class="container py-3">
    <div class="d-flex justify-content-between align-items-center page-header">
        <div>
            <a href="/" class="btn btn-outline-secondary">‚Üê Volver</a>
            <span class="fs-4 ms-3">Historial de reportes</span>
        </div>
        <div>
            <a href="{{ url_for('export_excel') }}?{% if request.query_string %}{{ request.query_string.decode('utf-8') }}{% endif %}" class="btn btn-success me-2">üì• Descargar Excel</a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-primary">üìä Dashboard</a>
        </div>
    </div>

    <div class="card mb-3 filters p-3">
        <form class="row g-2 align-items-center" method="get" action="{{ url_for('historial') }}">
            <div class="col-auto">
                <label class="small-muted">Tipo</label>
                <select class="form-select" name="tipo">
                    <option value="todos" {% if filtros.tipo=='todos' %}selected{% endif %}>Todos</option>
                    <option value="helada" {% if filtros.tipo=='helada' %}selected{% endif %}>Helada temprana</option>
                    <option value="compresion" {% if filtros.tipo=='compresion' %}selected{% endif %}>Compresi√≥n simple</option>
                </select>
            </div>
            <div class="col-auto">
                <label class="small-muted">Desde</label>
                <input class="form-control" type="date" name="fecha_desde" value="{{ filtros.fecha_desde or '' }}">
            </div>
            <div class="col-auto">
                <label class="small-muted">Hasta</label>
                <input class="form-control" type="date" name="fecha_hasta" value="{{ filtros.fecha_hasta or '' }}">
            </div>
            <div class="col-auto">
                <label class="small-muted">Por p√°gina</label>
                <select class="form-select" name="per_page">
                    {% set p = filtros.per_page | default(20) | int %}
                    <option value="10" {% if p==10 %}selected{% endif %}>10</option>
                    <option value="20" {% if p==20 %}selected{% endif %}>20</option>
                    <option value="50" {% if p==50 %}selected{% endif %}>50</option>
                    <option value="100" {% if p==100 %}selected{% endif %}>100</option>
                </select>
            </div>
            <div class="col-auto align-self-end">
                <button class="btn btn-primary" type="submit">Filtrar</button>
            </div>
        </form>
    </div>

    <div class="table-wrap">
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm mb-0">
                <thead class="table-dark">
                    <tr>
                        {% for col in columnas %}
                        <th scope="col">{{ col }}</th>
                        {% endfor %}
                        <th scope="col">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fila in registros %}
                    <tr>
                        {% for i in range(columnas|length) %}
                        <td>
                            {% set valor = fila[i] %}
                            {% if ('pdf' in (columnas[i]|lower)) and valor %}
                                <a class="btn btn-sm btn-outline-secondary" href="{{ valor }}" target="_blank">üìÑ Abrir PDF</a>
                            {% else %}
                                {{ valor }}
                            {% endif %}
                        </td>
                        {% endfor %}
                        <td>
                            <a class="btn btn-sm btn-info action-btn" href="{{ url_for('ver_reporte', reporte_id=fila[0]) }}">Ver</a>
                            <form method="post" action="{{ url_for('borrar_reporte', reporte_id=fila[0]) }}" style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Borrar registro ID {{ fila[0] }}?');">Borrar</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Paginaci√≥n -->
    <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="small-muted">Mostrando p√°gina {{ page }} / {{ total_pages }} ‚Äî {{ total_count }} registros</div>
        <nav aria-label="Paginaci√≥n">
            <ul class="pagination mb-0">
                {% set start = page-2 if page-2>1 else 1 %}
                {% set end = page+2 if page+2<total_pages else total_pages %}
                {% if page>1 %}
                <li class="page-item"><a class="page-link" href="{{ url_for('historial', tipo=filtros.tipo, fecha_desde=filtros.fecha_desde, fecha_hasta=filtros.fecha_hasta, per_page=filtros.per_page, page=1) }}">¬´</a></li>
                <li class="page-item"><a class="page-link" href="{{ url_for('historial', tipo=filtros.tipo, fecha_desde=filtros.fecha_desde, fecha_hasta=filtros.fecha_hasta, per_page=filtros.per_page, page=page-1) }}">‚Äπ</a></li>
                {% endif %}
                {% for pnum in range(start, end+1) %}
                <li class="page-item {% if pnum==page %}active{% endif %}"><a class="page-link" href="{{ url_for('historial', tipo=filtros.tipo, fecha_desde=filtros.fecha_desde, fecha_hasta=filtros.fecha_hasta, per_page=filtros.per_page, page=pnum) }}">{{ pnum }}</a></li>
                {% endfor %}
                {% if page<total_pages %}
                <li class="page-item"><a class="page-link" href="{{ url_for('historial', tipo=filtros.tipo, fecha_desde=filtros.fecha_desde, fecha_hasta=filtros.fecha_hasta, per_page=filtros.per_page, page=page+1) }}">‚Ä∫</a></li>
                <li class="page-item"><a class="page-link" href="{{ url_for('historial', tipo=filtros.tipo, fecha_desde=filtros.fecha_desde, fecha_hasta=filtros.fecha_hasta, per_page=filtros.per_page, page=total_pages) }}">¬ª</a></li>
                {% endif %}
            </ul>
        </nav>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
